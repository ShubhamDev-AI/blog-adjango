{% extends "base.html" %}
{% load blog_tags %}

{% block title %}My Blog{% endblock %}
{% block content %}
  
{% comment %} side bar {% endcomment %}
    {% include 'account/sidebar.html'%}
{% comment %} end side bar {% endcomment %}
        <!-- Page Content  -->
<div id="content" class="p-4 p-md-5 pt-5">

<h2 class="mb-4">Posts ranking</h2>
{% comment %} dropdown {% endcomment %}
      
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Dropdown
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                {% for category in category_details%}
                  <a class="dropdown-item" href="{% url 'blog:category' category|slugify %}">{{ category }}</a>
                {% endfor %}
                </div>
              </li>
    

                {% comment %} end drop {% endcomment %}
 

                      
{% for post in posts %}
  <div class="jumbotron" >
    <div class="fluid-container">
       <div class="row">
          <div class="col-md-12 col-lg-12 col-xl-12">
              <h2>
                <a href="{{ post.get_absolute_url }}">
                  {{ post.title }}  
                </a>
                <a href="{% url 'blog:category' post.category|slugify %}">{{ post.category }}</a>
                {% comment %} edit post {% endcomment %}
            {% if user.is_authenticated%}
                {% if user.id == post.author.id %}
                  <a href="{% url 'blog:update_post' post.pk %}">
                    Edit Post 
                  </a>
                  <a href="{% url 'blog:delete_post' post.pk %}">
                    Delete Post 
                  </a>
                {% endif %}
            {% else %}
            <h4>Login to edit Post</h4>
            {% endif %}
                  {% comment %} total views {% endcomment %}
                {{post.total_views}} 
                  {% comment %} view {% endcomment %}
                  <span class="count">
                          {{ total_views }} Your view{{ total_views|pluralize }}
                  </span>
              
              </h2>
            </div>
        </div>
            <hr/>
       <div class="row">
           <div class="col-md-12 col-lg-12 col-xl-12">
              <p>
                  Tags:
                  {% for tag in post.tags.all %}
                      <a href="{% url "blog:post_list_by_tag" tag.slug %}">
                          {{ tag.name }}
                      </a>
                    {% if not forloop.last %}, {% endif %}
                  {% endfor %}
            </p>
              <p>
                Published {{ post.publish }} by {{ post.author }}
              </p>
        
          <p class="lead"> 
              {{ post.body|markdown|truncatewords_html:30 }}
          </p>
        </div>
      </div>
                          {% comment %} like {% endcomment %}
          {% with total_likes=post.user_like.count user_like=post.user_like.all %}
                <div class="image-info">
                      <div>
                        <span class="count">
                          <span class="total">{{ total_likes }}</span>
                                  like{{ total_likes|pluralize }}
                        </span>
                          <a href="#" data-id="{{ post.id }}" data-action="{% if request.user in user_like %}un{% endif %}like" class="like button">
                              {% if request.user not in user_like %}
                                          Like
                              {% else %}
                                          Unlike
                              {% endif %}
                          </a>
                      </div>
                  </div>
                      <div class="image-likes">
                        {% for user in post.users_like.all %}
                          <div>
                             <p> <img src="{{ user.profile.photo.url }}">
                                  <p>{{ user.first_name }}</p>
                          </div>
                        {% empty %}
                          Nobody likes this post yet.
                        {% endfor %}
                      </div>
                      {% endwith %}
                          {% comment %} end post like {% endcomment %}
      
    </div>
  </div>
{% endfor %}

{% include "pagination.html" with page=posts %}

{% comment %} side bar {% endcomment %}
    

      </div>
		 
{% endblock %}

{% block domready %}
  $('a.like').click(function(e){
    e.preventDefault();
    $.post('{% url "blog:like" %}',
      {
        id: $(this).data('id'),
        action: $(this).data('action')
      },
      function(data){
        if (data['status'] == 'ok')
        {
          var previous_action = $('a.like').data('action');

          // toggle data-action
          $('a.like').data('action', previous_action == 'like' ?
          'unlike' : 'like');
          // toggle link text
          $('a.like').text(previous_action == 'like' ? 'Unlike' :
          'Like');

          // update total likes
          var previous_likes = parseInt($('span.count .total').text());
          $('span.count .total').text(previous_action == 'like' ?
          previous_likes + 1 : previous_likes - 1);
        }
      }
    );
  });
{% endblock %}

